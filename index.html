<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>iPA Groove</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="background.css">
    <link rel="stylesheet" href="navigation.css">
    <link rel="stylesheet" href="sections.css">
    <link rel="stylesheet" href="games.css">
    <link rel="stylesheet" href="apps.css">
    <link rel="stylesheet" href="menu.css">
    <link rel="stylesheet" href="chat.css">
    <link rel="stylesheet" href="auth.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="modal.css">
</head>
<body>

    <video class="video-bg" autoplay muted loop playsinline>
        <source src="https://raw.githubusercontent.com/iPAGroove/Innovation/main/videos/%D0%A4%D0%BE%D0%BD.mp4" type="video/mp4">
        <source src="https://raw.githubusercontent.com/iPAGroove/Innovation/main/videos/background1.webm" type="video/webm">
    </video>

    <div class="screen" id="gamesScreen">
        <div class="search-bar">
            <input type="search" placeholder="Search games..." />
        </div>

        <div class="category-section"><h2 class="section-title">VIP</h2><div class="horizontal-scroll" id="games-vip"></div></div>
        <div class="category-section"><h2 class="section-title">FREE</h2><div class="horizontal-scroll" id="games-free"></div></div>
        <div class="category-section"><h2 class="section-title">UPDATES</h2><div class="horizontal-scroll" id="games-updates"></div></div>
        <div class="category-section"><h2 class="section-title">TOP</H2><div class="horizontal-scroll" id="games-top"></div></div>
    </div>

    <div class="screen" id="appsScreen">
        <div class="search-bar">
            <input type="search" placeholder="Search apps..." />
        </div>

        <div class="category-section"><h2 class="section-title">VIP</h2><div class="horizontal-scroll" id="apps-vip"></div></div>
        <div class="category-section"><h2 class="section-title">FREE</h2><div class="horizontal-scroll" id="apps-free"></div></div>
        <div class="category-section"><h2 class="section-title">UPDATES</H2><div class="horizontal-scroll" id="apps-updates"></div></div>
        <div class="category-section"><h2 class="section-title">TOP</H2><div class="horizontal-scroll" id="apps-top"></div></div>
    </div>

    <div id="menuPanel" class="menu-panel">
        <div class="menu-content">
            <div class="auth-container">
                <div class="auth-tabs">
                    <button id="loginTab" class="auth-tab-btn active" data-form="login">Sign In</button>
                    <button id="registerTab" class="auth-tab-btn" data-form="register">Sign Up</button>
                </div>

                <form id="loginForm" class="auth-form active">
                    <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
                    <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
                    <button id="loginBtn" type="submit">Sign In</button>
                    <p id="loginError" class="auth-error"></p>
                </form>

                <form id="registerForm" class="auth-form">
                    <input type="email" id="registerEmail" placeholder="Email" autocomplete="email">
                    <input type="text" id="registerNickname" placeholder="Nickname" autocomplete="nickname">
                    <input type="password" id="registerPassword" placeholder="Password" autocomplete="new-password">
                    <button id="registerBtn" type="submit">Sign Up</button>
                    <p id="registerError" class="auth-error"></p>
                </form>

                <div id="profileInfoContainer" class="profile-info-container" style="display: none;">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar-wrapper">
                                <img src="images/ipa_groove_avatar.png" alt="iPA Groove Avatar" class="profile-avatar">
                            </div>
                            <div class="profile-details">
                                <span id="profileNicknameDisplay" class="profile-title">Loading...</span>
                                <div class="profile-buttons">
                                    <button class="profile-btn free-access-btn">Free Access</button>
                                    <button class="profile-btn upgrade-vip-btn">⚡ Upgrade to VIP</button>
                                </div>
                            </div>
                        </div>

                        <div class="community-stats">
                            <h3 class="stats-title">Community Statistics</h3>
                            <div class="stat-item">
                                <span class="stat-number">0</span>
                                <span class="stat-text">DOWNLOADS</span>
                            </div>
                        </div>

                        <div class="account-settings-link-wrapper">
                            <a href="#" class="account-settings-link">
                                Account Settings
                                <svg class="arrow-down" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                                </svg>
                            </a>
                            <button id="logoutBtn" class="profile-btn free-access-btn" style="margin-top: 15px; width: 100%; display: none;">Sign Out</button>
                        </div>
                    </div>
                    <button id="openAdminPanel" class="profile-btn free-access-btn" style="margin-top: 15px; width: 100%; display: none;">ADD G/A</button>
                    <button id="openUsersPanel" class="profile-btn free-access-btn" style="margin-top: 5px; width: 100%; display: none;">STATUS USERS</button>
                </div>
            </div>
            <h2></h2>
            <ul class="menu-links">
                <li><a href="#"></a></li>
                <li><a href="#"></a></li>
                <li><a href="#"></a></li>
            </ul>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel">
        <div class="admin-content">
            <h2>Admin Panel</h2>
            <button class="close-btn" id="closeAdminPanel">×</button>
            <div class="admin-tabs">
                <button id="addGameTab" class="admin-tab-btn active" data-content="addGame">Add Game</button>
                <button id="addAppTab" class="admin-tab-btn" data-content="addApp">Add App</button>
                <button id="editItemsTab" class="admin-tab-btn" data-content="editItems">Edit Items</button>
            </div>

            <div id="addGameSection" class="admin-section active">
                <h3>Add New Game</h3>
                <form id="addGameForm" class="add-item-form">
                    <input type="text" id="gameName" placeholder="Game Name" required>
                    <input type="text" id="gameIconUrl" placeholder="Icon URL" required>
                    <input type="url" id="gameDownloadLink" placeholder="Download Link (IPA/APK/DMG)" required>
                    <input type="text" id="gameSize" placeholder="Size (e.g., 1.2 GB)" required>
                    <input type="text" id="gameMinimaliOS" placeholder="Minimum iOS Version (e.g., iOS 13.0)" required>
                    <input type="text" id="gameHackFeatures" placeholder="Hack Features (e.g., Unlimited Coins)" >
                    <select id="gameType" multiple required>
                        <option value="vip">VIP</option>
                        <option value="free">FREE</option>
                        <option value="updates">UPDATES</option>
                        <option value="top">TOP</option>
                    </select>
                    <button type="submit">Add Game</button>
                    <p id="gameMessage" class="admin-message"></p>
                </form>
            </div>

            <div id="addAppSection" class="admin-section">
                <h3>Add New App</h3>
                <form id="addAppForm" class="add-item-form">
                    <input type="text" id="appName" placeholder="App Name" required>
                    <input type="text" id="appIconUrl" placeholder="Icon URL" required>
                    <input type="url" id="appDownloadLink" placeholder="Download Link (IPA/APK/DMG)" required>
                    <input type="text" id="appSize" placeholder="Size (e.g., 500 MB)" required>
                    <input type="text" id="appMinimaliOS" placeholder="Minimum iOS Version (e.g., iOS 14.0)" required>
                    <input type="text" id="appHackFeatures" placeholder="Hack Features (e.g., Ad-free)" >
                    <select id="appType" multiple required>
                        <option value="vip">VIP</option>
                        <option value="free">FREE</option>
                        <option value="updates">UPDATES</option>
                        <option value="top">TOP</option>
                    </select>
                    <button type="submit">Add App</button>
                    <p id="appMessage" class="admin-message"></p>
                </form>
            </div>

            <div id="editItemsSection" class="admin-section">
                <h3>Edit Games/Apps</h3>
                <div class="item-list-container">
                    <h4>Games:</h4>
                    <ul id="editGamesList" class="edit-list"></ul>
                    <h4>Apps:</h4>
                    <ul id="editAppsList" class="edit-list"></ul>
                </div>

                <form id="editItemForm" class="add-item-form" style="display: none;">
                    <input type="hidden" id="editItemId">
                    <input type="hidden" id="editItemCollection">
                    <input type="text" id="editItemName" placeholder="Name" required>
                    <input type="text" id="editItemIconUrl" placeholder="Icon URL" required>
                    <input type="url" id="editItemDownloadLink" placeholder="Download Link" required>
                    <input type="text" id="editItemSize" placeholder="Size" required>
                    <input type="text" id="editItemMinimaliOS" placeholder="Minimum iOS" required>
                    <input type="text" id="editItemHackFeatures" placeholder="Hack Features" >
                    <select id="editItemType" multiple required>
                        <option value="vip">VIP</option>
                        <option value="free">FREE</option>
                        <option value="updates">UPDATES</option>
                        <option value="top">TOP</option>
                    </select>
                    <button type="submit">Save Changes</button>
                    <button type="button" id="deleteItemBtn" class="delete-btn">Delete</button>
                    <button type="button" id="cancelEditBtn" class="cancel-btn">Cancel</button>
                    <p id="editMessage" class="admin-message"></p>
                </form>
            </div>
        </div>
    </div>

    <div id="usersPanel" class="admin-panel">
        <div class="admin-content">
            <h2>User Management</h2>
            <button class="close-btn" id="closeUsersPanel">×</button>
            <div class="item-list-container">
                <h4>User List:</h4>
                <ul id="usersList" class="edit-list"></ul>
            </div>

            <form id="editUserForm" class="add-item-form" style="display: none;">
                <input type="hidden" id="editUserId">
                <input type="text" id="editUserEmail" placeholder="User Email" disabled>
                <input type="text" id="editUserNickname" placeholder="User Nickname">
                <label for="editUserStatus">Status:</label>
                <select id="editUserStatus">
                    <option value="free">Free</option>
                    <option value="vip">VIP</option>
                </select>
                <label for="vipEndDate" style="display: none;">VIP End Date (YYYY-MM-DD):</label>
                <input type="date" id="vipEndDate" style="display: none;">
                <button type="submit">Save Changes</button>
                <button type="button" id="cancelUserEditBtn" class="cancel-btn">Cancel</button>
                <p id="userMessage" class="admin-message"></p>
            </form>
        </div>
    </div>


    <div id="chatModal" class="chat-modal">
        <div class="chat-content">
            <button class="close-btn" id="closeChat">×</button>
            <div class="chat-tabs">
                <button class="chat-tab-btn" data-chat-type="support">SUPPORT</button>
                <button class="chat-tab-btn active" data-chat-type="chat">Chat</button>
                <button class="chat-tab-btn" data-chat-type="news">NEWS</button>
            </div>

            <div id="chatMainArea" class="chat-main-area">
                <div id="messagesDisplay" class="messages-display">
                </div>
                <div class="chat-input-area">
                    <textarea id="messageInput" class="message-input" placeholder="Type your message..."></textarea>
                    <button id="sendMessageBtn" class="send-message-btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 4L3 11L10 14L20 4ZM20 4L13 21L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="itemDetailModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeItemDetailModal">×</button>
            <h2 id="modalItemName"></h2>
            <img id="modalItemIcon" src="" alt="Item Icon">
            <p>Size: <span id="modalItemSize"></span></p>
            <p>Minimum iOS: <span id="modalItemMinimaliOS"></span></p>
            <p>Hack Features: <span id="modalItemHackFeatures">N/A</span></p>
            <p class="modal-vip-status">Status: <span id="modalItemType"></span></p>
            <button id="modalDownloadBtn" class="modal-download-btn" target="_blank" rel="noopener noreferrer">Download</button>
            <p id="modalVipMessage" class="modal-message" style="display: none; color: #dc3545;">VIP content requires VIP status to download.</p>
        </div>
    </div>


    <nav class="bottom-nav">
        <a href="#" class="nav-item" id="openGames" title="Games">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M6 14H4L2 18V20H6L7 18L6 14ZM18 14H20L22 18V20H18L17 18L18 14ZM10 9H14V11H10V9ZM8 7H16V13H8V7Z" fill="white"/>
            </svg>
        </a>
        <a href="#" class="nav-item" id="openApps" title="Apps">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 4H10V10H4V4ZM14 4H20V10H14V4ZM4 14H10V20H4V14ZM14 14H20V20H14V14Z" fill="white"/>
            </svg>
        </a>
        <a href="#" class="nav-item" id="openChat" title="Chat">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 4H20V20H4V4ZM4 4L12 13L20 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </a>
        <a href="#" class="nav-item" id="openMenu" title="Menu"> <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 6H20M4 12H20M4 18H20" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, getDoc, doc, updateDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2In0cOmuiYB6zNj0dQrdJ8bwPkINKdzA",
            authDomain: "updaterepoipa.firebaseapp.com",
            projectId: "updaterepoipa",
            storageBucket: "updaterepoipa.appspot.com",
            messagingSenderId: "621595788422",
            appId: "1:621595788422:web:180163c46b349232243d07",
            measurementId: "G-T42CG13QPR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.addDoc = addDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.collection = collection;

        // Global variable to store user's VIP status
        window.currentUserIsVip = false;
        window.currentUserVipEndDate = null; // VIP end date

        // Updated renderCard function to support multiple types and Hack Features
        function renderCard(data, isUserVip) {
            const typesArray = Array.isArray(data.type) ? data.type : [data.type];
            const isVipContent = typesArray.includes('vip');
            const blockedClass = isVipContent && !isUserVip ? ' blocked' : '';
            const vipTag = isVipContent ? '<span class="vip-tag">VIP</span>' : '';

            return `
                <div class="icon-card${blockedClass}"
                     data-name="${data.name}"
                     data-iconurl="${data.iconUrl}"
                     data-downloadlink="${data.downloadLink || ''}"
                     data-size="${data.size || 'N/A'}"
                     data-minimalios="${data.minimaliOS || 'N/A'}"
                     data-hackfeatures="${data.hackFeatures || 'N/A'}"
                     data-type="${JSON.stringify(typesArray)}"
                     data-is-vip-content="${isVipContent}">
                    <img src="${data.iconUrl}" alt="${data.name}">
                    <span>${data.name}</span>
                    ${vipTag}
                </div>`;
        }


        window.loadRealtimeCollection = function(collName, prefix) { // Make function global
            const containers = {
                vip: document.getElementById(`${prefix}-vip`),
                free: document.getElementById(`${prefix}-free`),
                updates: document.getElementById(`${prefix}-updates`),
                top: document.getElementById(`${prefix}-top`),
            };

            onSnapshot(collection(db, collName), (snapshot) => {
                // Clear all containers first
                Object.values(containers).forEach(container => {
                    if (container) container.innerHTML = '';
                });

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const types = Array.isArray(d.type) ? d.type : [d.type]; // Ensure it's an array

                    types.forEach(type => {
                        if (containers[type]) {
                            containers[type].innerHTML += renderCard(d, window.currentUserIsVip);
                        } else {
                            console.warn(`Unknown type '${type}' in document ${doc.id} collection ${collName}`);
                        }
                    });
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("gamesScreen").style.display = "block";
            document.getElementById("appsScreen").style.display = "none";

            // initial calls - they will be re-rendered when user auth state changes
            window.loadRealtimeCollection('Games', 'games');
            window.loadRealtimeCollection('Apps', 'apps');

            console.log('✅ Realtime: Games and Apps subscribed to Firebase');
        });

    </script>

    <script src="script.js"></script>
    <script src="menu.js"></script>
    <script type="module" src="profile.js"></script>
    <script type="module" src="auth.js"></script>
    <script type="module" src="chat.js"></script>
    <script type="module" src="admin.js"></script>
    <script type="module" src="modal.js"></script>
</body>
</html>
